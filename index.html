<?php
/**
 * ====================================================================
 * LOGIQUE PHP POUR LE TEST DE SERVEUR (BACK-END)
 * ====================================================================
 * Ce bloc PHP intercepte la requ√™te AJAX POST envoy√©e par le JavaScript
 * pour effectuer le test de connectivit√© r√©el du serveur CCcam.
 */

// --- Fonction de Test R√©el du Serveur ---
function check_cccam_status($host, $port, $timeout = 2) {
    // Nettoyage de l'h√¥te
    $host = trim($host, '[]');
    $host = preg_replace('/^(\w+:\/\/)/', '', $host); 
    
    // Tente d'ouvrir une socket
    // Le @ masque les avertissements/erreurs PHP si la connexion √©choue
    $fp = @fsockopen($host, $port, $errno, $errstr, $timeout);
    
    if ($fp) {
        fclose($fp);
        return true; // Connexion r√©ussie
    }
    return false; // √âchec de la connexion
}

// --- Gestion de la Requ√™te AJAX ---
if (isset($_POST['action']) && $_POST['action'] === 'test_server' && isset($_POST['host']) && isset($_POST['port'])) {
    
    // 1. D√©finir l'en-t√™te JSON imm√©diatement pour √©viter l'erreur '<'
    header('Content-Type: application/json');
    
    // V√©rification rapide de la fonction fsockopen
    if (!function_exists('fsockopen')) {
        echo json_encode(['status' => 'error', 'message' => 'La fonction PHP fsockopen est d√©sactiv√©e sur ce serveur. Le test r√©el est impossible.']);
        exit;
    }
    
    // Utilisation d'un bloc try/catch pour garantir une r√©ponse JSON en cas d'erreur fatale
    try {
        $host = filter_var($_POST['host'], FILTER_SANITIZE_STRING);
        $port = filter_var($_POST['port'], FILTER_SANITIZE_NUMBER_INT);
        
        if (empty($host) || empty($port)) {
            echo json_encode(['status' => 'error', 'message' => 'H√¥te ou Port manquant.']);
            exit;
        }
        
        // Ex√©cution du test r√©el
        $is_online = check_cccam_status($host, (int)$port);
        
        if ($is_online) {
            echo json_encode(['status' => 'online', 'message' => "‚úÖ Serveur $host:$port est en LIGNE."]);
        } else {
            echo json_encode(['status' => 'offline', 'message' => "‚ùå Serveur $host:$port est HORS LIGNE ou le port est ferm√©."]);
        }

    } catch (Exception $e) {
        // Erreur PHP interne attrap√©e
        echo json_encode(['status' => 'error', 'message' => 'Erreur interne du serveur PHP: ' . $e->getMessage()]);
    }
    exit;
}
// Si la requ√™te n'est PAS un test AJAX, le script continue pour afficher le HTML.
?>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testeur de Serveur CCcam R√©el</title>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        header {
            background-color: #4CAF50;
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        main {
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #4CAF50;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        button, #status-filter {
            background-color: #5cb85c;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #4cae4c;
        }

        hr {
            border: 0;
            height: 1px;
            background-color: #ddd;
            margin: 30px 0;
        }

        /* Section de Saisie du Serveur */
        #single-server-line {
            width: 98%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: monospace;
        }

        .status-message {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .note {
            font-style: italic;
            color: #555;
            font-size: 0.9em;
        }

        /* Tableau et Filtres */
        #filter-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        #clines-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        #clines-table th, #clines-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        #clines-table th {
            background-color: #4CAF50;
            color: white;
        }

        /* Statuts */
        .online-status {
            color: #28a745; /* Vert */
            font-weight: bold;
        }

        .offline-status {
            color: #dc3545; /* Rouge */
            font-weight: bold;
        }

        .buttons-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    
    <header>
        <h1>Testeur de Serveur CCcam</h1>
    </header>
    
    <main>
        <section id="server-input">
            <h2>Tester un Serveur Int√©gr√© (Test R√©el via PHP)</h2>
            <p>Format : C: hostname port user pass (Ex: C: cccam.ugeen.live 28000 95146 ugeen)</p>
            <textarea id="single-server-line" rows="2" placeholder="Entrez la ligne de serveur ici..."></textarea>
            <button id="test-single-server">Tester ce Serveur</button>
            <div id="single-server-status" class="status-message"></div>
            <p class="note">‚úÖ Le test de connexion utilise **PHP (back-end)** pour v√©rifier l'ouverture du port. Il n√©cessite un serveur PHP actif.</p>
        </section>

        <hr>

        <section id="bulk-operations">
            <h2>Gestion des Clines (Fichier)</h2>
            <div class="buttons-container">
                <input type="file" id="file-upload" accept=".txt,.cfg" style="display: none;">
                <button onclick="document.getElementById('file-upload').click()">Importer un Fichier (.txt/.cfg)</button>
                <button id="save-local-button">üíæ Sauvegarder Localement</button>
                <button id="download-text-button">üì• T√©l√©charger les Clines (Format Texte)</button>
            </div>
            <div id="file-info"></div>
        </section>

        <hr>

        <section id="data-display">
            <h2>Statut des Clines (Statuts du Fichier sont Simul√©s)</h2>
            <div id="filter-stats">
                <p>Total Clines: <span id="count-total">0</span> | En Ligne: <span id="count-online" class="online-status">0</span> | Hors Ligne: <span id="count-offline" class="offline-status">0</span></p>
                <label for="status-filter">Filtrer par statut:</label>
                <select id="status-filter">
                    <option value="all">Tout</option>
                    <option value="online">En Ligne</option>
                    <option value="offline">Hors Ligne</option>
                </select>
            </div>
            <table id="clines-table">
                <thead>
                    <tr>
                        <th>H√¥te</th>
                        <th>Port</th>
                        <th>Utilisateur</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Testeur CCcam | N√©cessite PHP</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileUpload = document.getElementById('file-upload');
            const tableBody = document.querySelector('#clines-table tbody');
            const statusFilter = document.getElementById('status-filter');
            const saveLocalButton = document.getElementById('save-local-button');
            const downloadTextButton = document.getElementById('download-text-button');
            const singleServerLine = document.getElementById('single-server-line');
            const testSingleServerButton = document.getElementById('test-single-server');
            const singleServerStatusDiv = document.getElementById('single-server-status');

            let clinesData = [];

            // --- Fonctions d'Utilit√© ---

            /**
             * @brief Analyse une ligne CCcam de mani√®re robuste (gestion des espaces, tirets, etc.).
             */
            function parseCline(line) {
                // Supprime les espaces inutiles, assure que la ligne commence par 'C:', et remplace les espaces ou tirets multiples par un seul espace.
                const cleanedLine = line.trim().toUpperCase()
                    .replace(/^-+/, '') 
                    .replace(/\s+/g, ' ');

                if (!cleanedLine.startsWith('C:')) {
                    return null;
                }

                const parts = cleanedLine.substring(2).trim().split(' ');

                if (parts.length < 4) {
                    return null;
                }

                const [host, port, user, pass] = parts.slice(0, 4);

                if (isNaN(parseInt(port)) || parseInt(port) <= 0) {
                    return null;
                }

                // STATUT SIMUL√â pour le tableau de masse.
                const status = Math.random() < 0.7 ? 'online' : 'offline';

                return { host, port, user, pass, status };
            }
            
            /**
             * @brief Effectue la requ√™te de test r√©elle vers le script PHP.
             */
            async function testServerViaPHP(host, port) {
                const formData = new FormData();
                formData.append('action', 'test_server');
                formData.append('host', host);
                formData.append('port', port);
                
                try {
                    const response = await fetch('index.php', { // Requ√™te vers le m√™me fichier
                        method: 'POST',
                        body: formData
                    });

                    // Tente de r√©cup√©rer le JSON. Si cela √©choue, c'est l'erreur que vous avez eue.
                    const text = await response.text();
                    try {
                        const result = JSON.parse(text);
                        return result; 
                    } catch (e) {
                        console.error("Erreur de parsing JSON:", text);
                        return { status: 'error', message: `Erreur de communication : R√©ponse du serveur inattendue (voir console).` };
                    }
                } catch (error) {
                    console.error("Erreur de communication avec le serveur PHP:", error);
                    return { status: 'error', message: `Erreur de communication: ${error.message}` };
                }
            }


            /**
             * @brief Affiche les donn√©es des clines dans le tableau et met √† jour les compteurs.
             */
            function renderTable(filter) {
                tableBody.innerHTML = '';
                let onlineCount = 0;
                let offlineCount = 0;

                clinesData.forEach(cline => {
                    if (cline.status === 'online') onlineCount++;
                    else if (cline.status === 'offline') offlineCount++;
                });

                const filteredClines = clinesData.filter(cline => {
                    return filter === 'all' || cline.status === filter;
                });

                document.getElementById('count-total').textContent = clinesData.length;
                document.getElementById('count-online').textContent = onlineCount;
                document.getElementById('count-offline').textContent = offlineCount;

                // Affichage des messages si le tableau est vide
                if (clinesData.length === 0) {
                    const row = tableBody.insertRow();
                    row.innerHTML = `<td colspan="4" style="text-align: center;">Aucune cline charg√©e.</td>`;
                    return;
                }
                
                if (filteredClines.length === 0) {
                    const row = tableBody.insertRow();
                    row.innerHTML = `<td colspan="4" style="text-align: center;">Aucune cline correspondant au filtre "${filter.toUpperCase()}" n'a √©t√© trouv√©e.</td>`;
                    return;
                }


                filteredClines.forEach(cline => {
                    const row = tableBody.insertRow();
                    const statusClass = cline.status === 'online' ? 'online-status' : 'offline-status';
                    const statusText = cline.status === 'online' ? '‚úÖ EN LIGNE' : '‚ùå HORS LIGNE';

                    row.innerHTML = `
                        <td>${cline.host}</td>
                        <td>${cline.port}</td>
                        <td>${cline.user}</td>
                        <td class="${statusClass}">${statusText}</td>
                    `;
                });
            }

            /**
             * @brief Charge les donn√©es sauvegard√©es localement (LocalStorage).
             */
            function loadLocalData() {
                const savedData = localStorage.getItem('cccamClines');
                if (savedData) {
                    try {
                        clinesData = JSON.parse(savedData);
                        renderTable(statusFilter.value);
                    } catch (e) {
                        console.error("Erreur de chargement des donn√©es locales:", e);
                    }
                } else {
                    renderTable('all'); 
                }
            }

            // --- GESTIONNAIRES D'√âV√âNEMENTS ---

            // 1. Importation de fichier
            fileUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    const lines = content.split('\n');
                    let validClines = [];
                    let invalidCount = 0;

                    lines.forEach(line => {
                        const cline = parseCline(line);
                        if (cline) {
                            validClines.push(cline);
                        } else if (line.trim().length > 0 && !line.trim().startsWith('#')) {
                            invalidCount++;
                        }
                    });

                    clinesData = validClines;
                    renderTable(statusFilter.value);
                    document.getElementById('file-info').textContent = `Fichier charg√©. ${validClines.length} clines valides trouv√©es (Statuts Simul√©s). ${invalidCount} lignes ignor√©es.`;
                    event.target.value = '';
                };
                reader.readAsText(file);
            });

            // 2. Filtrage du tableau
            statusFilter.addEventListener('change', (event) => {
                renderTable(event.target.value);
            });

            // 3. Sauvegarde locale
            saveLocalButton.addEventListener('click', () => {
                if (clinesData.length > 0) {
                    localStorage.setItem('cccamClines', JSON.stringify(clinesData));
                    alert('Donn√©es sauvegard√©es localement dans votre navigateur !');
                } else {
                    alert('Rien √† sauvegarder. Importez des clines d\'abord.');
                }
            });

            // 4. T√©l√©chargement en format Texte
            downloadTextButton.addEventListener('click', () => {
                if (clinesData.length === 0) {
                    alert("Aucune donn√©e √† t√©l√©charger.");
                    return;
                }
                
                const fileContent = clinesData
                    .map(cline => `C: ${cline.host} ${cline.port} ${cline.user} ${cline.pass}`)
                    .join('\n');

                const blob = new Blob([fileContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'clines_export.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            // 5. Test de serveur unique (R√©el via PHP)
            testSingleServerButton.addEventListener('click', async () => {
                const line = singleServerLine.value.trim();
                if (!line) {
                    singleServerStatusDiv.className = 'status-message offline-status';
                    singleServerStatusDiv.textContent = 'Veuillez entrer une ligne de serveur.';
                    return;
                }

                const cline = parseCline(line);

                if (!cline) {
                    singleServerStatusDiv.className = 'status-message offline-status';
                    singleServerStatusDiv.textContent = '‚ùå Ligne de serveur invalide. Format attendu : "C: host port user pass".';
                    return;
                }

                // Affichage du chargement
                testSingleServerButton.disabled = true;
                singleServerStatusDiv.className = 'status-message';
                singleServerStatusDiv.textContent = `‚è≥ Test en cours de ${cline.host}:${cline.port} via PHP...`;

                // Appel de la fonction asynchrone pour le test r√©el
                const result = await testServerViaPHP(cline.host, cline.port);

                // Affichage du r√©sultat
                if (result.status === 'online') {
                    singleServerStatusDiv.className = 'status-message online-status';
                    singleServerStatusDiv.innerHTML = `‚úÖ **EN LIGNE** : ${result.message}`;
                } else if (result.status === 'offline') {
                    singleServerStatusDiv.className = 'status-message offline-status';
                    singleServerStatusDiv.innerHTML = `‚ùå **HORS LIGNE** : ${result.message}`;
                } else {
                    // Erreur captur√©e par PHP ou erreur de communication
                    singleServerStatusDiv.className = 'status-message offline-status';
                    singleServerStatusDiv.innerHTML = `‚ö†Ô∏è **ERREUR** : ${result.message}`;
                }
                
                testSingleServerButton.disabled = false;
            });

            // Initialisation
            loadLocalData();
        });
    </script>
</body>
</html>
